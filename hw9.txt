grigory.kislin [11:34 PM] 
joined #hw9.


grigory.kislin [11:34 PM] 
set the channel topic: https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson09.md


grigory.kislin [11:35 PM] 
Готово 9е занятие
Наконец делаем настоящую авторизацию, ее тестирование и отрисовку таблиц по AJAX.


[11:35] 
успехов!


Constantine [11:38 PM] 
joined #hw9 along with 18 others.



----- Today January 9th, 2018 -----
vsimonov [11:11 AM] 
патч Apply 9_03_HW8_enable_disable.patch не встаёт из-за public void testEnable() , у всех так?

Антон Кляшторный [6 hours ago] 
похоже так


Pavel [4 hours ago] 
+1


Katherine Buzatu [3 hours ago] 
У меня 9_03_HW8 без проблем.


tema.emelyan [3 hours ago] 
тоже без проблем


itAvgur [14 minutes ago] 
no problem!


Dmitry Makarov [12 minutes ago] 
все ок

shaakem [15 hours ago] 
Все норм. В Version Control чисто перед накаткой?


Andrew [15 hours ago] 
Такая же беда...


Andrew [14 hours ago] 
Как вы решили проблему?


Katherine Buzatu [14 hours ago] 
А при накатке все изменения были отмечены?


Andrew [14 hours ago] 
Да


Andrew [14 hours ago] 
Откатился, и не помогло- Киньте пожалуйста класс после этого патча, чтобы проигнорировать ханки


Katherine Buzatu [14 hours ago] 
А класс какой?


Andrew [14 hours ago] 
AbstractUserServiceTest


Few [5:49 PM] 
IP адрес getbootstrap.com внесен Роскомнадзором в реестр запрещенных (на этом же IP адресе якобы детское порно)
мой "ответственный" провайдер заблокировал :slightly_smiling_face:

itAvgur [17 hours ago] 
Кстати, не только он.
Еще какие-то сайты программерской направленности попадались, которые работали ТОЛЬКО из-под того же FreeGate'а. (edited)


Dmitry Makarov [17 hours ago] 
у вас хотя бы пишет, что сайт заблокирован. У меня заблокированные сайты просто не грузятся


Few [17 hours ago] 
да у меня так же, я через ТП узнал что он заблокирован
предъявил им что они могли бы хоть простенькую страничку с причиной выводить...


dart_rabbit [8:12 PM] 
Я так понимаю, что to мы вводим ради ajax и прямого биндинга объектов? Потому как скрыть поля обычном rest можно и через @JsonIgnore.

Katherine Buzatu [15 hours ago] 
А как же exceeded? Это отдельное поле, нужное только для фронта.


vch [15 hours ago] 
а его тоже можно в entity указать, пометив как `@Transient` :slightly_smiling_face:


Andrew [8:51 PM] 
9_03_HW8_enable_disable.patch: проблема с накаткой тоже. Сверил код с базой - этот класс идентичен. В чём же соль?


[8:54] 
В итоге должен какой класс получится?


Katherine Buzatu [9:05 PM] 
added this Java snippet: AbstractUserServiceTest.java
package ru.javawebinar.topjava.service;
​
import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cache.CacheManager;
import org.springframework.dao.DataAccessException;
import ru.javawebinar.topjava.model.Role;
import ru.javawebinar.topjava.model.User;
import ru.javawebinar.topjava.util.exception.NotFoundException;
​
import java.util.Collections;
import java.util.Date;
import java.util.List;
​
import static ru.javawebinar.topjava.UserTestData.*;
​
public abstract class AbstractUserServiceTest extends AbstractServiceTest {
​
  @Autowired
  protected UserService service;
​
  @Autowired
  private CacheManager cacheManager;
​
  @Before
  public void setUp() throws Exception {
    cacheManager.getCache("users").clear();
  }
​
  @Test
  public void create() throws Exception {
    User newUser = new User(null, "New", "new@gmail.com", "newPass", 1555, false, new Date(), Collections.singleton(Role.ROLE_USER));
    User created = service.create(newUser);
    newUser.setId(created.getId());
    assertMatch(service.getAll(), ADMIN, newUser, USER);
  }
​
  @Test(expected = DataAccessException.class)
  public void duplicateMailCreate() throws Exception {
    service.create(new User(null, "Duplicate", "user@yandex.ru", "newPass", Role.ROLE_USER));
  }
​
  @Test
  public void delete() throws Exception {
    service.delete(USER_ID);
    assertMatch(service.getAll(), ADMIN);
  }
​
  @Test(expected = NotFoundException.class)
  public void notFoundDelete() throws Exception {
    service.delete(1);
  }
​
  @Test
  public void get() throws Exception {
    User user = service.get(ADMIN_ID);
    assertMatch(user, ADMIN);
  }
​
  @Test(expected = NotFoundException.class)
  public void getNotFound() throws Exception {
    service.get(1);
  }
​
  @Test
  public void getByEmail() throws Exception {
    User user = service.getByEmail("admin@gmail.com");
    assertMatch(user, ADMIN);
  }
​
  @Test
  public void update() throws Exception {
    User updated = new User(USER);
    updated.setName("UpdatedName");
    updated.setCaloriesPerDay(330);
    updated.setRoles(Collections.singletonList(Role.ROLE_ADMIN));
    service.update(updated);
    assertMatch(service.get(USER_ID), updated);
  }
​
  @Test
  public void getAll() throws Exception {
    List<User> all = service.getAll();
    assertMatch(all, ADMIN, USER);
  }
​
  @Test
  public void testEnable() {
    service.enable(USER_ID, false);
    Assert.assertFalse(service.get(USER_ID).isEnabled());
    service.enable(USER_ID, true);
    Assert.assertTrue(service.get(USER_ID).isEnabled());
  }
}
Add Comment Collapse




grigory.kislin [9:20 PM] 
сегодня письмо с меня и счас патчи вчекиню



----- Today January 10th, 2018 -----
Viktor [3:06 AM] 
мне интересно стало, почему методы конвертации UserTo в User и обратно вынесены в утильный класс. Почему бы не научить сам UserTo конвертироваться и создаваться из User'a. Есть ли какая-то важная причина использованию утилитарного класса, или просто так принято?


tema.emelyan [3:18 AM] 
@Viktor я слышал, что в то никакую логику обычно не помещают, только данные (edited)

itAvgur [6 hours ago] 
Иногда с припиской: "Если оооочень хочется, то можно".
Вообщем, вопрос стиля.


Konstantin [9:40 AM] 
Джаваскриптовая часть тяжело дается что-то. Вроде прошелся по основным разделам на w3schools.com. Там все легкие примеры, в проекте все фреймворки намешаны в кучу и возникает путанница


Alexander _Gubanow [10:12 AM] 
В нашем проекте Ajax запросы инициализируются браузером при выполнении пользователем каких-то действий,отсылаются на сервер. После обработки на сервере и получения ответа от сервера (по событию success в Ajax-запросе)   перерисовывается таблица с данными. А как реализовать функционал приложения, если сервер является инициализатором отправки данных? Например, на сервере есть какая-то очередь, куда складываются сообщения от разных пользователей, или пишутся логи от всех  событий на сервере, а сервер должен потом автоматически и динамически(то есть при появлении нового сообщения в очереди) отправить эти сообщения и показать пользователям в браузере.


Few [10:51 AM] 
Для этих целей Спринг предлагает WebSockets+SockJS+STOMP (Spring in Action, 4-е издание, глава 18) (edited)

Alexander _Gubanow [19 hours ago] 
@Few Спасибо. Почитал про WebSockets - там немного другая технология передачи данных. Всегда открыто дуплексное  соединение клиент/сервер после подключения клиента, в отличие от HTTP, где соединение происходит на время передачи данных. Хотелось все же услышать мнение гуру, если реализовать указанный выше функционал, например,если клиент будет  генерить каждые  n   секунд запросы на сервер по ajax - это не будет выглядить топорно в плане архитектуры приложения (с позиции  будущего работодателя)?


Few [18 hours ago] 
По описанной тобой логике, как раз видится наиболее правильным чтобы сервер отправлял сообщения подписавшимся на них клиентам . А для этого как раз STOMP лучше всего и подходит. Он в том числе отлично интегрируется с spring security (edited)


Few [18 hours ago] 
Хотя мнение гуру всегда интересно, ждем


philip.goldm [12:16 PM] 
@grigory.kislin обнаружил в Apply 9_07_datatable_via_ajax.patch небольшую проблему. 
В RootController убирается добавление списка пользователей из атрибутов модели
>model.addAttribute("users", userService.getAll());
Из-за этого падают тесты в RootControllerTest. Там есть проверки на наличие атрибута
>.andExpect(model().attribute("users", hasSize(2)))


Atrieron [1:19 PM] 
А у меня одного уже которое занятие не патчится список ролей админа в populateDB.sql? Приходится каждый раз заново заносить.

Katherine Buzatu [1 day ago] 
Роли были добавлены в 7_04_HW6. В патчах содержатся только последние изменения. Попробуй накатить из этого патча только изменения populate. И закоммитить в мастере. Я так думаю.


grigory.kislin [5:17 PM] 
@philip.goldm так и есть. но почему- проблема?

philip.goldm [22 hours ago] 
Да, уже догодался :)


MetalBro [4:18 AM] 
В чем заключается преимущество создания DTO если мы не формируем его из несвязанных сущностей или сущности с данными, не хранимыми в базе (типа MealWithExceed)? Например, userTo представляет собой урезанного User.  Для удобства работы на фронтенде (если точно известна его структура)?
1 reply Today at 12:09 PM View thread

Ivanushka [9:57 AM] 
added and commented on this Java snippet: Господа (товарищи) ткните пальцем...
Есть два контроллера c методом getAll():
@RestController
@RequestMapping("/ajax/admin/users")
public class AdminAjaxController extends AbstractUserController {
​
  @Override
  @GetMapping(produces = MediaType.APPLICATION_JSON_VALUE)
  public List<User> getAll() {
    return super.getAll();
  }
}
​
и...
@RestController
@RequestMapping(AdminRestController.REST_URL)
public class AdminRestController extends AbstractUserController {
  static final String REST_URL = "/rest/admin/users";
​
  @Override
  @GetMapping(produces = MediaType.APPLICATION_JSON_VALUE)
  public List<User> getAll() {
    return super.getAll();
  }
1 Comment Collapse
Почему через SoapUI GET /topjava/rest/admin/users мне прилетает JSON, а через GET /topjava/ajax/admin/users возвращается HTML? (Почувствовал себя обезьяной, пилящей атомную бомбу)



Few [11:06 AM] 
@Ivanushka из за spring security


Ivanushka [11:08 AM] 
@Few Спасибо, посмотрю. Но и там и там в Soap настраивал Authentication


Few [11:12 AM] 
@Ivanushka <http pattern="/rest/**" use-expressions="true" name="restSecurityFilterChain" create-session="stateless">
       <http-basic/>
       <intercept-url pattern="/rest/admin/**" access="hasRole('ROLE_ADMIN')"/>
       <intercept-url pattern="/**" access="isAuthenticated()"/>
       <csrf disabled="true"/>
   </http>


[11:12] 
вот из-за этого

[11:12] 
для ajax таких настроек нет

[11:13] 
возвращает тебе html страницы логина т.к. ты не авторизован


Ivanushka [11:20 AM] 
@Few Спасибо ещё раз, точно. :+1:


Katherine Buzatu [2:42 PM] 
Товарищи, у нас появился `UserTo`. Помнится, когда мы делали разделение приложения на слои, была речь о том, что про ТО знает только слой веб. Новоиспеченный же `UserTo` оказывается у нас не только в сервисе, но еще и разбросан между сервисом и контроллером (update/save). Почему `UserTo` не оставили только в контроллере, реализовав слоями ниже обновление отдельных полей (типа нынешнего `enable()`)?

anpotashev [2:57 PM] 
"ТО знает только слой веб" - мне кажется неправильное высказывание. TO скорее используется для передачи данных м/ду слоями приложения и/или во вне.
"Почему не использовать отдельные параметры" - теряется гибкость: 
Допустим надо добавить/изменить/удалить поле в ТО. В случае с параметрами придется переписывать все функции на всех слоях. А в случае с ТО - максимум только в начальной и конечной точках.


Katherine Buzatu [3:07 PM] 
Ну, или тогда преобразовывать все в сервисе. Вот конкретно этот кусок мне не нравится:
```if (userTo.isNew()) {
            super.create(UserUtil.createNewFromTo(userTo));
        } else {
            super.update(userTo, userTo.getId());
        }```


anpotashev [3:17 PM] 
Тут согласен. Красивее вынести в сервис. Имхо, разумеется.


Katherine Buzatu [3:22 PM] 
Еще кажется избыточным параметр `id` в `update(UserTo userTo, int id)`. Если раньше мы его получали отдельно из `PathVariable` и проверяли соответствие, то сейчас они априори равны, т. к. мы уже подаем `id=userTo.getId()`.


anpotashev [3:30 PM] 
Тут могу только предположить, что в REST также будет изменено на DTO


anpotashev [3:35 PM] 
А кто-нибудь сделал без костылей так чтобы в окне редактирования еды нормально отображалась дата-время? (edited)


Serge [6:32 PM] 
uploaded and commented on this image: 2018-01-11 в 19.27.45.jpg
1 Comment
Ребят, кто поборол DateTimePicker… Не могу понять его волшебную логику. При обновлении ДАТУ и ЧАСЫ считывает с поля, а МИНУТЫ ставит текущего времени
Кто как округлял эти минуты?



Anel [6:53 PM] 
Кто-нибудь может ткнуть пальцем, откуда у нас появляется topjava в url? У меня все упорно работает по ссылкам вида: http://localhost:8080/rest/admin/users  без /topjava/


Katherine Buzatu [8:34 PM] 
uploaded and commented on this image: image
1 Comment
@Anel



Anel [8:40 PM] 
@Katherine Buzatu :+1: спасибо!


Andrew [8:53 PM] 
После устновки патчей у меня не запускается, падает с NoSuchBeanDefinitionException: No bean named 'userService' available. Так должно быть?

Dmitry Makarov [18 hours ago] 
у меня работает


Anel [9:01 PM] 
uploaded and commented on this image: message.png
1 Comment
И еще, кто-то может объяснить, что значит сообщение:



dart_rabbit [9:07 PM] 
@Anel Открой свойства проекта, фасет спринга


Anel [9:11 PM] 
uploaded and commented on this image: message2.png
1 Comment
@dart_rabbit



Andrew [9:17 PM] 
Это было, помогло клин-пекедж


Anel [9:29 PM] 
@Andrew а поподробнее?


Andrew [9:29 PM] 
Maven-Clean, Maven-Package


[9:30] 
Видимо, что-то где-то подвисло


Anel [9:34 PM] 
Не помогает ( на самом деле, такая же проблема в проекте, в котором, по факту, только эти 5 конфигурационных файлов спринг + pom + web.xml

Andrew [17 hours ago] 
Контекст подключен? И клин не помог?


Anel [17 hours ago] 
Клин/пекедж никакого эффекта не дает. Аналогичная ситуация на топджаве. так приложение без проблем работат. все контексты поднимаются


Andrew [16 hours ago] 
Это я так понимаю, после всех патчей и без изменений HW9? userService бин декларируется в security.xml. Может, где-то объявлен бин уже с таким именем?


Anel [16 hours ago] 
нет, это в пустом проекте, без userService бина


Andrew [16 hours ago] 
А, так в чём проблема тогда?


Anel [16 hours ago] 
понять хочу, что это такое


Andrew [10:01 PM] 
Это нормально, что у User есть кнопка Users, которая при нажатии кидает алерт с еррором?


Viktor [10:21 PM] 
А ктонибудь пытался напрямую обращаться по адресам localhost:8080/ajax/admin/users и прочим ajax?  С ними что-то не то и я не понимаю почему. Или я что-то делаю не так
Пробую обратиться по указанному выше в браузере все норм, даже в дебаг попадаю. Пробую тоже самое через постмана или SoapUI возвращает стартовую страницу авторизации, не 401 код а именно всю страницу с авторизацией (edited)


Viktor [10:21 PM] 
uploaded this image: Из браузера
1 Comment



Viktor [10:21 PM] 
uploaded this image: Из постмана
Add Comment



Viktor [10:22 PM] 
added this Plain Text snippet: Заголовки запроса из браузера
GET /ajax/admin/users HTTP/1.1
Host: localhost:8080
Connection: keep-alive
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
Accept-Encoding: gzip, deflate, br
Accept-Language: ru,en-US;q=0.9,en;q=0.8
Cookie: JSESSIONID=BEDABCE11E37467ADFE7C60195494142
Add Comment Collapse



Viktor [10:23 PM] 
added this Plain Text snippet: заголовки из постмана
GET /ajax/admin/users HTTP/1.1
Host: localhost:8080
Authorization: Basic YWRtaW5AZ21haWwuY29tOmFkbWlu
Cache-Control: no-cache
Postman-Token: 903e0f06-f90e-4209-00e0-94a9e1db50a7
Add Comment Collapse



Viktor [10:24 PM] 
uploaded this image: Левый запрос
Add Comment



Viktor [10:25 PM] 
Самое забавное, что через постмана можно обратиться к любому адресу и любым запросом и он возвращает главную страницу. Через браузер такое не прокатывает.


[10:25] 
Мне непонятно, что за фигня происходит :smiley: (edited)

Andrew [10:37 PM] 
Там же в хедерах надо креденшлы передавать, у нас вроде выключены сессии для реста


[10:40] 
В MailTo LocalDateTime должно быть поле? Или магия не может и надо стрингом принимать дату? Не могу заставить магию преобразовывать

Viktor [10:40 PM] 
повесь над полем аннаотацию форматтера


Andrew [10:41 PM] 
Пробовал, но видимо ему надо и велью указать


Viktor [10:43 PM] 
"я тебе вылью". Иногда лучше использовать русские слова, либо английские писать английскими буквами=)


Dmitry Makarov [10:54 PM] 
Viktor, ты о какой аннотации говоришь?

Andrew [16 hours ago] 
@DateTimeFormat


Viktor [10:54 PM] 
@Andrew спасибо, поставил в настройках создание сессии и через /rest смог все таки дотянуться до /ajax


[10:55] 
@Dmitry Makarov
   @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME)



Katherine Buzatu [10:55 PM] 
commented on Viktor’s file Из браузера
Недавно обсуждался смысл ТО. Вот, пожалуйста, слились все пользовательские пароли.




Viktor [10:56 PM] 
ну так-то они все равно должны быть закодированны :smiley:



----- Today January 12th, 2018 -----
Andrew [12:43 AM] 
datetimepicker: подключить зависимость достаточно или надо ещё и скрипты с ЦСС добавлять? У меня пустые рамки появляются..

anpotashev [14 hours ago] 
css добавил?
```<link rel="stylesheet" href="webjars/datetimepicker/2.5.11/jquery.datetimepicker.css">```


Andrew [13 hours ago] 
Уже настроил.. Но видимо надо специальный формат даты отправлять, чтобы читался спрингом..


Andrew [13 hours ago] 
Пока не нашёл нужный


Andrew [13 hours ago] 
Мне по фильтр приходят все нуллы


anpotashev [13 hours ago] 
формат можно задать в аннотации над полем.


Katherine Buzatu [2:25 PM] 
Измучили меня уже эти датаТаймы. В ISO - из ISO... Мне кажется, что надо конвертировать в ISO на клиенте, и отдавать на сервер уже в ISO. От ДатаПикера приходит датаТайм с пробелом. Обойти это на js вышло, но грубо как-то, некрасиво. Разверните, пожалуйста, в нужном направлении движения.