grigory.kislin [1:37 AM] 
joined #hw4.


grigory.kislin [1:37 AM] 
set the channel topic: https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson04.md


grigory.kislin [1:38 AM] 
Занятие 4: https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson04.md
ORM, JPA, Hibernate
GitHub
JavaWebinar/topjava
Contribute to topjava development by creating an account on GitHub.
 
(edited)


YuriyD [1:42 AM] 
joined #hw4 along with 18 others.


itAvgur [6:25 AM] 
Интересно у меня idea пропатчила sql скрипты в патче 1. Прибавила еще одну таблица meals.
В итоге две таблицы, пришлось выкусывать старые.


Few
[6:52 AM] 
ты патчи то на мастер накатывай, а не на HW3


[6:53] 
там не должно быть таблицы meals


itAvgur [7:25 AM] 
А еще я пользуюсь IDEA  и изучаю JAVA ? :grinning:
Ну конечно же master.
Ладно, проехали. Это у меня в мастере кусок кода видно остался. (edited)


Tanya [7:50 AM] 
возможно не закоммитил изменения перед переходом на мастер

Few
[7:53 AM] 
@itAvgur это было бы слишком очевидно, да? :grinning:


itAvgur [8:02 AM] 
Это дело было так: исправил два скрипта sql, а УЖЕ ПОТОМ создал HW03.
Визуально - все пучком. А при возврате в мастер эти изменения там и проявились.
2Few Никаких костылей - только ХАРДКОР!
Офтопик закончил. :no_entry: (edited)


Valery [8:40 AM] 
>В JdbcUserRepositoryImpl.save() и UserServiceImpl.update добавил проверку на несуществующей в базе User.id
А разве в этом месте не вернется ошибка при попытке обновить запись с несуществующим id? - 'WHERE id=:id'


Katherine Buzatu [8:45 AM] 
Не вернется. Просто строка с такими параметрами не будет найдена и ничего не будет изменено.


Антон Кляшторный [10:36 AM] 
*Зарефакторил в InMemoryMealRepositoryImpl.getAll/getBetween: filter() перед sorted() https://howtodoinjava.com/java-8/how-to-use-predicate-in-java-8/
HowToDoInJava
Java 8 Predicate Examples - HowToDoInJava
In java 8, Predicate a functional interface and can therefore be used as the assignment target for a lambda expression or method reference. So, where you think, you can use these true/false returning functions in day to day programming?
Apr 4th, 2014 at 5:37 PM
 


Marina [2:57 PM] 
Ребят, может у кого то такая же проблема - после накатки 4_6_add_jpa.patch, maven в idea подчеркивает зависимости, не могу никак исправить, в задании сказано: "При настройке JPA в IDEA НЕ скачивайте библиотеку javaee.jar (и любую другую). Все зависимости в проект попадают только через Maven". Не могу понять как это сделать.


grigory.kislin [3:03 PM] 
@Marina а maven рефреш (reimport all кнопка) делала?


Marina [3:04 PM] 
да, не помогает
Grigory Kislin
@Marina а maven рефреш (reimport all кнопка) делала?
Posted in #hw4Today at 3:03 PM


grigory.kislin [3:08 PM] 
а без idea- проект компилится?
mvn compile ? (edited)


MetalBro [5:06 PM] 
после 4.3 на Travis не билдится, выдает org.springframework.jdbc.datasource.init.ScriptStatementFailedException: Failed to execute SQL script statement #1 of class path resource [db/populateDB.sql]: DELETE FROM user_roles; nested exception is org.postgresql.util.PSQLException: ERROR: relation "user_roles" does not exist
 Position: 13


[5:06] 
и т.п.


MetalBro [5:06 PM] 
так должно быть?
1 reply Today at 5:15 PM View thread

philip.goldm [4 hours ago] 
Да

MetalBro [5:19 PM] 
Спасибо!


[5:20] 
в настройках на сайте не видно этого
отключил в настройках (remove pattern) проверку assert в JUnit (проверяем через матчеры) и meta http-equiv="content-type" в JSP
сделал remove pattern на Cross Site Scripting (XSS), будем делать защиту на последнем занятии
Где это вообще


MetalBro [5:25 PM] 
просто поудаляли замечания после проверки?


kadmser [5:32 PM] 
@MetalBro тоже сейчас не могу этого найти на сайте


MetalBro [5:36 PM] 
там получается когда он сделает список замечаний (у меня получилось 18) можно при раскрытии каждого щелкнуть на значке настройки и сказать ignore issue, remove pattern


[5:37] 
в проекте, ссылка куда идет из нового задания, таких замечаний нет, там не обновлено с 3 урока у него


[5:38] 
не очень удобно, когда непонятно что точно должно быть после патчей


kadmser [6:07 PM] 
добавляю проекты из гитхаба на  versioneye.com , а список все равно остается пустой


kadmser 
[7:06 PM] 
А, все ок. Нужно просто было включить ветку


MetalBro [7:08 PM] 
какие у тебя issues?


[7:09] 
есть The method getBetween() has an NPath complexity of 625 ?

Marina [7:36 PM] 
Что я совсем запуталась, откатила на патч 4-5 и теперь не могу снова накатить 4-6, выдает ошибку: Failed to make the following files writable:
/home/marina/IdeaProjects/topjava/src/main/resources/spring/spring-db.xml
/home/marina/IdeaProjects/topjava/src/main/resources/db/postgres.properties
/home/marina/IdeaProjects/topjava/pom.xml
/home/marina/IdeaProjects/topjava/src/main/java/ru/javawebinar/topjava/model/User.java
/home/marina/IdeaProjects/topjava/src/main/java/ru/javawebinar/topjava/model/AbstractNamedEntity.java
/home/marina/IdeaProjects/topjava/src/main/java/ru/javawebinar/topjava/model/Meal.java
/home/marina/IdeaProjects/topjava/src/main/java/ru/javawebinar/topjava/model/AbstractBaseEntity.java
Grigory Kislin
а без idea- проект компилится?
mvn compile ?
Posted in #hw4Today at 3:08 PM


Marina [10:03 PM] 
Вопрос снимается, наладилось.


MetalBro [11:23 PM] 
при коммите патча 4.7 выдает три ошибки, связанные с User в Named Query. Все норм?



----- Today November 24th, 2017 -----
Few [4:04 AM] 
Григорий в видео об этом говорит. Нужно JPA в фасеты добавить и базу указать


MetalBro [3:50 PM] 
Спасибо


grigory.kislin [4:15 PM] 
@MetalBro
> после 4.3 на Travis не билдится,
смотри- мы в первую очередь здесь учимся быть программистами. все остальное вторично...
как думаешь сам- в чем проблема ? должно быть так или нет? исправится это дальше?
1 reply Today at 5:42 PM View thread

[4:17] 
> при коммите патча 4.7 выдает три ошибки
то же самое. умение накатывать патчи - это же еще не программист
посмотри, где валится ... посмотри в код


[4:18] 
> Нужно JPA в фасеты добавить и базу указать
это же только интеграция с IDEA. никак на приложение не влияет


Few [4:22 PM] 
ну MetalBro имел ввиду ошибки анализа кода перед коммитом, насколько я понял


kadmser 
[4:39 PM] 
JPA нужно все таки через модули добавлять?


[4:39] 
а не через фасеты


grigory.kislin [4:47 PM] 
@kadmser как в видео


kadmser [4:48 PM] 
я засомневался что как в видео, когда открыл  "настройке JPA в IDEA"


philip.goldm [5:43 PM] 
@grigory.kislin привет! По поводу 3.2 и 3.3 заданий.
>3: Добавить в тесты MealServiceTest функциональность @Rule:
>3.1: проверку Exception
>3.2: вывод в лог времени выполнения каждого теста
>3.3: вывод сводки в конце класса: имя теста - время выполнения
Эти задания связаны с использованием `@Rule` функционала, то есть необходимо использовать Timeout Rule? Или просто необходимо реализовать время трассировки (время выполнения) ?


Tanya [9:21 PM] 
@philip.goldm timeout - это же просто ограничение на время выполнения


[9:21] 
надо узнать время выполнения теста и вывести в лог


philip.goldm [9:24 PM] 
Я это понял. Лучше вынести в отдельный пункт. И не ставить подпунктом @rule


Tanya [9:43 PM] 
3.2 через Rule, про timeout ничего не сказано (edited)
ну а 3.3. логично из 3.2 получается, сделать сводку


Alexander _Gubanow [1:05 PM] 
@grigory.kislin Свойства JPA обычно настраиваются в persistence.xml  файлe. Мы их настраиваем прямо в бине FactoryBean. Связано ли это с тем, что мы используем  Hibernate? И где можно бы почитать про это подробнее


Few [2:54 PM] 
Скорее это связано с использованием Спринга


[2:54] 
http://www.baeldung.com/the-persistence-layer-with-spring-and-jpa#xmlconfig
Baeldung
A Guide to Hibernate with Spring 4 | Baeldung
Setup JPA with Spring 4 - how to set up the EntityManager factory and use the raw JPA APIs.
Dec 18th, 2013 at 4:03 PM
 


Alexander _Gubanow [3:25 PM] 
Я понял,можно и без persistence.xml. Главное  packagesToScan определить


grigory.kislin [6:00 PM] 
>  Свойства JPA обычно настраиваются в persistence.xml  файлe.
вот тут можно, если кратко:  Настройка EntityManagerFactory
https://habrahabr.ru/post/232381/
Хабрахабр
По следам Spring Pet Clinic. Maven/ Spring Context/ Spring Test/ Spring ORM/ Spring Data JPA
Здравствуйте! Spring MVC, согласно обзору инструментов и технологий Java за 2014 г. от RevbelLabs, является самым популярным веб фреймворком. Далее тот же... (77 kB)


grigory.kislin [6:07 PM] 
Spring помогает, можно и без него:
https://stackoverflow.com/a/42372648/548473
https://stackoverflow.com/a/30909140/548473
и- почему не воспользоваться google ?? https://www.google.ru/search?newwindow=1&safe=active&ei=Y5QZWvj5OYPE6ATjpaqABg&q=JPA+without+%22persistence.xml%22&oq=JPA+without+%22persistence.xml%22&gs_l=psy-ab.3..0i203k1j0i22i30k1l9.208680.214131.0.214319.9.9.0.0.0.0.168.949.6j3.9.0....0...1c.1.64.psy-ab..0.9.934...0j0i7i30k1j0i7i5i30k1j0i7i30i19k1j0i7i5i30i19k1j0i8i7i30i19k1j0i5i30k1j0i8i30k1.0.OrPU3IT34Qk
stackoverflow.com
Create JPA EntityManager without persistence.xml configuration file
Is there a way to initialize the EntityManager without a persistence unit defined? Can you give all the required properties to create an entity manager? I need to create the EntityManager from the ...
 
 stackoverflow.com
JPA without persistence.xml
I'm trying to get started with using Guice Persist and JPA, which recommends using configuration via persistence.xml. Coming from a native Hibernate background where configuration was obtained
 


PugV
[6:40 PM] 
У меня такой вопрос возник. Почему JpaUserRepositoryImpl помечен @Transactional(readOnly = true), без Propagation.SUPPORTS. Ведь по дефолту получается при операции чтения  должна всегда создаваться новая транзакция, что является затратным.


grigory.kislin [7:08 PM] 
@PugV не то:)
в уроке есть ссылка, счас поищу


[7:08] 
вот: https://jira.spring.io/browse/DATAJPA-601

[7:08] 
:slightly_smiling_face:


PugV
[7:30 PM] 
ок. посмотрю, спасибо. Просто везде написано, что SUPPORTS идеально подходит для чтения)))


RNG [7:35 PM] 
Такая проблема: после того как я помечаю класс `Meal` аннотацией `@Entity` (со всеми другими вытекающими аннотациями на поля), у меня обваливаются тесты в `UserServiceTest` c такой ошибкой
```java.lang.IllegalStateException: Failed to load ApplicationContext Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory' defined in URL [file:/E:/ProjectsTraining/topjava12/target/classes/spring/spring-db.xml]: Invocation of init method failed; nested exception is org.hibernate.service.spi.ServiceException: Unable to create requested service [org.hibernate.engine.jdbc.env.spi.JdbcEnvironment]```
(edited)


[7:36] 
Если же убрать аннотацию `@Entity` с класса `Meal` все опять работает. (edited)

[7:38] 
С последнего патча 4.8 у меня появились изменения только в классах `Meal` и `JpaMealRepositoryImpl`, если что.


[7:40] 
Кто-то знает как пофиксить? Или может быть подскажите куда копать...

Few [7:56 PM] 
@PugV Вот еще нашел:


[7:56] 
https://www.ibm.com/developerworks/ru/library/j-ts1/index.html
ibm.com
Распространенные ошибки
В этой статье Марк Ричардс описывает распространенные подводные камни, которые могут привести к потере согласованности. Они объясняются на примерах, взятых из инфраструктуры Spring Framework и спецификации EJB (Enterprise JavaBeans) 3.0.
 


grigory.kislin [8:07 PM] 
@RNG см верх последнего эксепшена (edited)



[8:08] 
@PugV ты ссыку то почитай:) это статья, с которой я начал беседу


RNG [8:27 PM] 
Всё, проблему решил. Оказалось при создание запроса в `@NamedQuery` допустил ошибку.

Дима Жуков [8:41 PM] 
Ребята, у кого-нибудь было в MealServiceTest - org.hibernate.LazyInitializationException: could not initialize proxy - no Session?

Katherine Buzatu [8:47 PM] 
Думаю, у всех.


Дима Жуков [8:48 PM] 
@Katherine Buzatu это значит я на правильном пути?)


Katherine Buzatu [8:49 PM] 
Думаю, да. Только как это правильно обойти?..


MetalBro [8:53 PM] 
я изменил тесты


[8:54] 
нужно выкидывать сравнение по полю юзер

[8:54] 
хотя не помню, эта ошибка может на другое выскакивала

[8:55] 
куда выводить п3.3. ? Вывожу хитро, в консоль)

Katherine Buzatu [8:58 PM] 
> нужно выкидывать сравнение по полю юзер
ну да, так работает. А правильно ли это - юзера игнорировать? А вдруг он поменялся?


MetalBro [8:59 PM] 
его нет в MealTestData


[8:59] 
я долго тупил, почему у меня в логе пишет

Katherine Buzatu [8:59 PM] 
Тогда у нас и Юзера в Милзе не было.


MetalBro [8:59 PM] 
что два списка неэквивалентны, хотя сам же их выводит идентичные


[9:00] 
мы в тестах вроде как задаем условия, что при таком то юзере должен получиться такой то список


[9:00] 
а из базы нам приходит лишняя графа

Katherine Buzatu [9:01 PM] 
и должны проверить, что приходит нужная Еда нужного Юзера. А мы Юзера прокатили.


Nick [9:01 PM] 
Я просто переписал тесты с помощью коллекции Hamcrest


Дима Жуков 
[9:02 PM] 
Hamcrest?
 2 replies Last reply today at 9:13 PM View thread

MetalBro [9:02 PM] 
нет, мы подобрали заведомо правильный список

[9:02] 
public static final List<Meal> MEALS = Arrays.asList(MEAL6, MEAL5, MEAL4, MEAL3, MEAL2, MEAL1);


[9:02] 
здесь

[9:03] 
и в базу перед стартом закидываются эти данные


[9:04] 
только из базы приходится брать полностью строку

[9:04] 
//        assertThat(actual).usingFieldByFieldElementComparator().isEqualTo(expected);
       assertThat(actual).usingElementComparatorIgnoringFields("user").isEqualTo(expected);


[9:04] 
посмотрим еще что скажут на это


Katherine Buzatu [9:04 PM] 
Ну да, ну да... И методы правильные пишем, которые правильно все делают :slightly_smiling_face:


MetalBro [9:06 PM] 
если с 1 методом сделать, выставив fetchType.EAGER

[9:06] 
то выдаст

[9:06] 
Expecting:
<"[Meal{id=100010, dateTime=2015-06-01T18:00, description='Созданный ужин', calories=300},
   Meal{id=100007, dateTime=2015-05-31T20:00, description='Ужин', calories=510},
   Meal{id=100006, dateTime=2015-05-31T13:00, description='Обед', calories=1000},
   Meal{id=100005, dateTime=2015-05-31T10:00, description='Завтрак', calories=500},
   Meal{id=100004, dateTime=2015-05-30T20:00, description='Ужин', calories=500},
   Meal{id=100003, dateTime=2015-05-30T13:00, description='Обед', calories=1000},
   Meal{id=100002, dateTime=2015-05-30T10:00, description='Завтрак', calories=500}] (ArrayList@1e75d6a6)">
to be equal to:
<"[Meal{id=100010, dateTime=2015-06-01T18:00, description='Созданный ужин', calories=300},
   Meal{id=100007, dateTime=2015-05-31T20:00, description='Ужин', calories=510},
   Meal{id=100006, dateTime=2015-05-31T13:00, description='Обед', calories=1000},
   Meal{id=100005, dateTime=2015-05-31T10:00, description='Завтрак', calories=500},
   Meal{id=100004, dateTime=2015-05-30T20:00, description='Ужин', calories=500},
   Meal{id=100003, dateTime=2015-05-30T13:00, description='Обед', calories=1000},
   Meal{id=100002, dateTime=2015-05-30T10:00, description='Завтрак', calories=500}] (ArrayList@1e75d6a6)">
but was not.


[9:06] 
прикол да?


[9:07] 
возможно стоит тесты переработать, но это как партия скажет

Katherine Buzatu [9:09 PM] 
Мы тут не ждем партийных указаний. Мы думаем, надо это или нет для выполнения нашей задачи. :sunglasses:


MetalBro [9:11 PM] 
думаешь, есть смысл сравнивать поля юзера вместо забрасывания того что должно быть?

Дима Жуков [9:12 PM] 
Да что нибудь в meal entity не докрутили наверное. Какой нибудь экстра @ или join в запрос)


MetalBro [9:12 PM] 
до этого у нас было просто поле user_id, теперь там объект


[9:13] 
нет, получается поле user в классе meal хранит ссылку на объект другой таблицы по id

[9:13] 
вот кстати, все писали     @JoinColumn(name = "user_id") ? вроде как он сам и без этого понимает как связать...


philip.goldm [9:14 PM] 
@MetalBro, @Katherine Buzatu У меня такая же проблема с тестами


RNG [9:14 PM] 
И у меня тоже)


Katherine Buzatu [9:14 PM] 
@MetalBro
> думаешь, есть смысл сравнивать поля юзера
Поля не стоит, но id, думаю, надо.


MetalBro [9:15 PM] 
ты делала дебаг?


Katherine Buzatu [9:15 PM] 
Делала. (edited)


MetalBro [9:15 PM] 
там в поле объект хранится, а не id


Katherine Buzatu [9:15 PM] 
Прокси.

vch [9:16 PM] 
Вроде у этого прокси id должен быть доступен? И без всякого LazyException?


philip.goldm [9:19 PM] 
у меня сейчас валятся только testUpdateNotFound и testGetAll .
указываю FetchType.EAGER + у каждого теста добавляю @Transactional
https://cl.ly/0m3a1q1o1h3s

При этом если выполняешь отдельно testGetAll. Выполняется успешно 
https://cl.ly/3G1G0s2S2N15
Created with CloudApp, The Video and Image Sharing Platform - Sign Up for Free
Image 2017-11-25 at 9.19.34 PM.png (85 kB)
 Created with CloudApp, The Video and Image Sharing Platform - Sign Up for Free
Image 2017-11-25 at 9.19.22 PM.png (43 kB)
(edited)
2 replies Last reply today at 9:40 PM View thread

Katherine Buzatu [9:20 PM] 
Сверить-то в конечном счете можно. Не хочется верить, что на эту одну строчку кода с ORM надо писать километр тестов.


MetalBro [9:22 PM] 
m.dateTime BETWEEN


MetalBro [9:22 PM] 
а вот здесь идея ни у кого красным ошибку не подчеркивает по dateTime?)
1 reply Today at 9:23 PM View thread

MetalBro [9:22 PM] 
type mismatch что-то в этом роде)


[9:23] 
баг идеи какой-то

RNG [9:23 PM] 
@MetalBro погугли `@SuppressWarnings`


Дима Жуков [9:23 PM] 
Что то мне не нравится название suppress

[9:23] 
:slightly_smiling_face:

RNG [9:24 PM] 
Ну так оно работает же и с подчеркиванием. А это способ убрать это недоразумение :slightly_smiling_face:


anpotashev [9:25 PM] 
Всем привет!
Вопрос не из задания, а чисто академический. Если хочу чтоб поле email должно быть уникальным, но без учета регистра, то как его можно объявить?
В бд реализуется легко, а вот как можно описать в модели.
1 reply Today at 9:29 PM View thread

Дима Жуков [9:25 PM] 
У меня вроде не подчёркивает


[9:25] 
Но идея у меня 16.1

Дима Жуков [9:31 PM] 
@anpotashev orm аннотация какая для этого? Я пока знаю только not null)) но логично предположить что есть unique и email аннотации. Которая вообще проверит что там корректный емайл


[9:33] 
Опять таки какой то чувак там из видео показывал как свои аннотации делать.. :bike:


anpotashev [9:35 PM] 
Аннотация @Email немного для другого. Она служит для проверки что введенное значение похоже на email (содержит @ и т.п.). Интересует именно аннотации, для генерации таблиц.

[9:36] 
Можно еще в сеттер поля добавить преобразование к нижнему регистру, но, имхо, это не тру-вей


Дима Жуков 
[9:36 PM] 
Почему? Я кстати тоже хотел предложить


anpotashev [9:38 PM] 
Потому что в таком случае код будет выполнять то, что можно сделать в базе, тем же триггером. Или чем-то вроде 
"email VARCHAR_IGNORECASE(255) NOT NULL," (edited)


Дима Жуков 
[9:44 PM] 
Да и вообще, пусть будет у меня двойка по инкапсуляции. Но я не особо вижу смысла в сеттере если там нет проверки. Просто делать паблик поле тогда да и все. Смысл от сеттеров этих просто формальность и как стандарт просто. Ошибаюсь я конечно наверное. Но


[9:45] 
Но на будущее если только


anpotashev [9:47 PM] 
А ты можешь быть уверен что твой сеттер использует тот же спринг или хибернейт, а не сгенерирует свой сеттер для прокси-класса?


[9:51] 
Меня в данном случае интересует аннотации не для валидации, а для генерации таблиц. Вопрос, повторюсь, академический: генерить таблицы на основании классов сущностей в реальном проекте вряд-ли кто-то будет.


russell [9:53 PM] 
added and commented on this Java snippet
@Entity Foo { 
  private value;
  @Column(unique = true)
  private valueLowercased;
​
  @PrePersist @PreUpdate private prepare(){
    this.valueLowercased = value == null ? null : value.toLowerCase();
  }
}
1 Comment Collapse
@anpotashev в jpa нет такого, стек выдал вариант



new messages
vch [9:53 PM] 
@Дима Жуков без сеттеров всё равно не обойтись, даже если поля будут public. Spring MVC и др. требуют наличия сеттеров/геттеров


[9:55] 
@anpotashev
> генерить таблицы на основании классов сущностей в реальном проекте вряд-ли кто-то будет.
Значит я всю жизнь занимался нереальными проектами... :thinking_face: (edited)


grigory.kislin [9:57 PM] 
по поводу тестов не забываем правило: тесты для приложения, а не приложение для тестов:)
eager на каждую еду нам не нужен!
@anpotashev
c email мы решим проблему тем, что будем хранить email только в lowercase


anpotashev [9:58 PM] 
@vch значит ошибаюсь, тем более тогда интересно.



new messages
grigory.kislin [10:00 PM] 
@vch вы на проде таблицы автогенерите? миграцией не пользуетесь?


vch [10:03 PM] 
@grigory.kislin Да. Причём на многих проектах, у нескольких заказчиков. Проблем практически нет.
Миграцией последний раз я пользовался много лет назад (С++ и MsSQL), это был ад.


grigory.kislin [10:05 PM] 
мм. ну на моем простеньком javaops.ru с h2 автогенерация пару раз ложала


[10:05] 
да и вообще все рекомендации, которые я видел- не используют на проде (edited)

[10:06] 
hibernate? какая база?


anpotashev [10:06 PM] 
@vch, а как у вас обновления с изменениями структуры бд проходят?


vch [10:07 PM] 
@grigory.kislin значит мы везучие... Либо не используем те возможности Jpa/Hibernate, которые вызывают проблемы.
По разному. Есть и просто hibernate, есть и Jpa.
Продуктивные базы - PostgreSQL и MsSQL
Локальные тестовые - вроде h2


[10:10] 
@anpotashev При добавлении полей hibernate это определяет и создаёт поля в существующей таблице.
Все новые таблицы и связи тоже создаются.
Но нельзя удалять и менять что-то. Т.е. если удалил поле из entity - оно так и останется в БД (впрочем, это не проблема).
Или если к существующему полю добавили аннотацию @NotNull - то ограничение в базе не создастся.


grigory.kislin [10:11 PM] 
а, у меня на изменения наверно не работало. вы их руками делаете получается?


vch [10:11 PM] 
@grigory.kislin что именно руками?


anpotashev [10:11 PM] 
А если требуется разделить таблицу, тоже нормально проходит?


grigory.kislin [10:11 PM] 
> удалять и менять что-то


anpotashev [10:13 PM] 
У нас было такое, что раньше это было просто поле, а после обновления - это отношение один ко многим. Hibernate разруливает?


vch [10:14 PM] 
@grigory.kislin Поля из entity удалять можно безопасно, а то, что они в базе остались - никому не мешает. Да и редко удаляем что-то
@anpotashev
> это отношение один ко многим. Hibernate разруливает?
нет. Но никто же не запрещает изменить название поля. (edited)


[10:16] 
@anpotashev
>А если требуется разделить таблицу, тоже нормально проходит?
Не совсем понял о каком разделении речь... Но это всё равно сведётся, наверно, к добавлению / удалению полей в entity


RNG [10:17 PM] 
Приложение работает четко, а с тестов только тесты с NotFoundException. Это получается терь тесты переписывать тоже?

philip.goldm [10:19 PM] 
@RNG а у тебя testGetAll() тест отрабатывает правильно?


anpotashev [10:21 PM] 
@vch простой пример из головы - было поле контактный номер, после обновления контактных номеров стало несколько. У нас все подобные изменения выполнялись с помощью присланных sql-запросов.


RNG [10:21 PM] 
@philip.goldm Не-а, рабочие тесты только `testDeleteNotFound()`, `testGetNotFound()`, `testUpdateNotFound()`. Но повторюсь, приложение при этом все равно работает.

anpotashev [10:22 PM] 
@RNG а приложение сортирует?


[10:23] 
И как сравниваешь?

philip.goldm [10:23 PM] 
у меня также, все работает (и сортировка) кроме тестов. Сейчас не работает только два теста
https://cl.ly/2p1e0b1Y0Y0T (edited)


[10:25] 
уже часа три мучаюсь, не получается

RNG [10:26 PM] 
@anpotashev Сортировка работает (edited)


vch [10:26 PM] 
@anpotashev Ну т.е. было поле в User `String phone`
После обновления - сделали новое Entity
```public class PhoneNumber extends DBEntity {
    User user;
    String phone;
}```
Связь односторонняя - в таблице `User` никакие поля не нужны, поле `user.phone` просто перестало использоваться.
Вообще проблем не вижу для обновления (конечно, если на `user.phone` не стояло @NotNull ) (edited)


anpotashev [10:29 PM] 
Но ведь надо в новую таблицу phoneUser загнать существующие данные по phone из user.
Поэкспериментирую на досуге, если что обращусь с вопросом.

vch [10:31 PM] 
@anpotashev А вот для этого уже придётся скрипт делать, да. Но это очень редко бывает. 
Большинство обновлений при развитии проекта - добавление полей/таблиц


RNG [10:33 PM] 
@anpotashev По поводу сравнения, ты об этом `m.user.id=:userId`? (edited)

anpotashev [10:34 PM] 
Нет, я про сравнение в MealTestData


[10:35] 
У меня работает только при исключении поля user из сравнения.

[10:35] 
С ним вылетает could not initialize proxy - no Session


RNG [10:36 PM] 
@anpotashev Я тесты не меня пока кардинально. Там ведь скорее всего тогда упадут тесты при подключении `JdbcMealRepositoryImpl`, если их поменять


anpotashev [10:37 PM] 
У тебя тест testGet с чем падает?


RNG [10:38 PM] 
@anpotashev
```org.hibernate.LazyInitializationException: could not initialize proxy - no Session```


anpotashev [10:40 PM] 
Вот. У меня так же. Попробуй исключить поле user из метода проверки в MealTestData.


Few 
[10:49 PM] 
вот я так сделал, а можем ли мы так делать?


[10:50] 
по идее вроде можем

anpotashev [10:51 PM] 
@Few тоже не уверен что правильно. Ищу решение, пока безрезультатно.

Few [10:53 PM] 
нет ну можно EAGER поставить и это тоже решит проблему

[10:53] 
но это тоже не правильно

[10:53] 
ради теста таскать из базы пользователя

philip.goldm [10:54 PM] 
@anpotashev
>Попробуй исключить поле user из метода проверки в MealTestData.
я добавил User объекты из UserTestData во время инициализации Meals. То есть я не исключал,а на оборот добавил.


[10:55] 
у меня работает, кроме testGetAll теста ))

Few 
[10:56 PM] 
а getAll на что ругается?

anpotashev [10:58 PM] 
Добавить можно только в значения expected, если не ошибаюсь.
А ошибка инициализации для acrual происходит.

philip.goldm [11:02 PM] 
>а getAll на что ругается?
https://cl.ly/0n1G3C2n1A3v
Поля не одинаковые. С testGetAll  вообще странное поведение. При запуске в группе есть ошибка. А когда запускаешь отдельно Нет ошибки. И при этом поля в actual and expected одинаковые.
Created with CloudApp, The Video and Image Sharing Platform - Sign Up for Free
Image 2017-11-25 at 11.00.33 PM.png (113 kB)


[11:03] 
не знаю как быть дальше

MetalBro [11:06 PM] 
При запуске в группе возможно проходят тесты, которые изменяют состояние в базе и возникает отличие для твоего getall


[11:07] 
Посмотрел скрин, ну у меня также было

[11:08] 
Покажи запрос на геталл в базу)

philip.goldm [11:08 PM] 
я тоже так думал. вручную проверял actual and expected три раза. Даже вложенный User одинаковый

MetalBro [11:08 PM] 
Ну значит юзера как-то сравнивать надо. Возможно там не все comparable

philip.goldm [11:09 PM] 
тоже склоняюсь

anpotashev [11:09 PM] 
А что у тебя в методе public static void assertMatch(Iterable<Meal> actual, Iterable<Meal> expected) {


MetalBro [11:10 PM] 
Ещё вариант. Если в поле юзера в базе хранится только ссылка, то их сравнение по идее тоже false даст


[11:11] 
Ссылки разные, хоть объекты и одинаковые

[11:11] 
Или нет?


philip.goldm [11:12 PM] 
https://cl.ly/0W3r2M1G0E11
Aleksandr N Potashev
А что у тебя в методе public static void assertMatch(Iterable<Meal> actual, Iterable<Meal> expected) {
Posted in #hw4Yesterday at 11:09 PM
 Created with CloudApp, The Video and Image Sharing Platform - Sign Up for Free
Image 2017-11-25 at 11.12.13 PM.png (143 kB)


[11:13] 
Да, ссылкы разные. Но в assertThat . usingFieldByFieldElementComparator проверка идет по объектам а не по ссылкам (edited)


anpotashev [11:22 PM] 
uploaded this image: Pasted image at 2017-11-26, 12:22 AM
Add Comment



anpotashev [11:23 PM] 
uploaded this image: Pasted image at 2017-11-26, 12:23 AM
Add Comment



anpotashev [11:23 PM] 
т.е. дело все-таки в user


MetalBro [11:24 PM] 
ну это известно. А почему?

[11:25] 
в смысле, вот philip втаскивал юзеров в тестовые данные


[11:25] 
не получилось чего-то


Few 
[11:27 PM] 
Может конечно Hibernate надо уметь готовить, но с JDBC все было как-то прозрачнее и понятнее


anpotashev [11:27 PM] 
Тоже втащил в тестовые данные.
Вот еще скрин


anpotashev [11:27 PM] 
uploaded this image: Pasted image at 2017-11-26, 12:27 AM
Add Comment



anpotashev [11:28 PM] 
это в getall


[11:29] 
И это только с нулевым элементом acrual


Few [11:29 PM] 
Мы же когда вытаскиваем из базы данные, берем их для конкретного пользователя, так зачем нам после этого в тестах сверять этого пользователя?
1 reply Today at 12:32 AM View thread
MetalBro [1 hour ago] 
я тоже считаю, что не нужно. Но народу интересно

anpotashev [11:42 PM] 
@philip.goldm  а не пробовал временно поменять LAZY на EAGER?



----- Today November 26th, 2017 -----
Viktor [12:48 AM] 
Посмотрев видео где ругают хибернейт стало интересно, почему мы используем id для hashCode. Лучше ли будет определить в meal и user свои equals и hashCode например по полю email и date


anpotashev [1:25 AM] 
uploaded and commented on this image: Pasted image at 2017-11-26, 2:24 AM
1 Comment
Но теперь, если проверять поле user, не проходят тесты на jdbc-репе. Чего и следовало ожидать.



Dmitry Makarov [1:43 AM] 
разве нужно его проверять?


anpotashev [1:52 AM] 
Не думаю.

Viktor [3:10 AM] 
По идее не надо, т.к. user  поменяться не может, нет пока такого api. Передается mealWithExceeded, там про пользователя ни слова, во всех стальных запросах у нас идут только id. кроме создания. С другой стороны модель поменялась и тесты (+ тестовые данные) должны поменяться.


grigory.kislin [4:35 AM] 
добавил в урок подсказку:
5: Когда будете чинить `MealServiceTest`, помните, что тесты пишутся для приложения, а не наоборот.


vsimonov [12:33 PM] 
Как с этой бедой бороться ? 
org.hibernate.LazyInitializationException: could not initialize proxy - no Session

Katherine Buzatu [12:35 PM] 
Думаю, надо попробовать избежать обращений к незагруженному объекту.



vch [12:38 PM] 
Неужели действительно нет способа сделать нормальную проверку с юзером? Должны же быть варианты... Теоретически.


Few [12:39 PM] 
он у нас и впилен-то в Meal ради JPA, а теперь еще и проверять его? :slightly_smiling_face:



vch [12:40 PM] 
@Few Ну если это тест репозитория, то по идее надо. Вдруг репозиторий что-то не то возвращает. Иначе какой смысл вообще тест писать?


Few [12:43 PM] 
ну тогда на время разработки можно включить @ManyToOne(fetch = FetchType.EAGER)

[12:43] 
будет работать

[12:43] 
вот бы как-нибудь переключать только для тестирования


[12:45] 
хотя мы же тестовые данные создаем, мы знаем какому юзеру они принадлежат

vsimonov [12:45 PM] 
с EAGER ошибка пропадает , но тесты не проходят


Few 
[12:45 PM] 
и если все совпадает, значит работает как надо


[12:50] 
@vsimonov вариантов может быть куча. Я час не меньше просидел над отладкой репозитория по логам тестов. Это и есть самая полезная часть обучения по моему мнению: разобраться что не так


anpotashev [12:51 PM] 
Можно добавить @Transactional к тестовому классу


[12:52] 
Тогда ошибки с LAZY initialization не будет

Дима Жуков
[12:53 PM] 
Похоже не плохое решение! (edited)


[12:54] 
А что это transactional делает?


vsimonov [12:55 PM] 
added this Plain Text snippet
Аннотация @Transactional указывает, что метод должен выполняться в транзакции. Менеджер транзакций открывает новую транзакцию и создаёт для неё экземпляр Session, который доступен через sessionFactory.getCurrentSession(). Все методы, которые вызываются в методе с данной аннотацией, также имеют доступ к этой транзакции, потому что экземпляр Session является переменной потока (ThreadLocal)
Add Comment



vsimonov [12:56 PM] 
одна сессия на методы, у нас проблема с открытием новых сессий


Дима Жуков
[12:57 PM] 
А почему не пофиг что одна сессия на методы?


anpotashev [12:57 PM] 
Для тестов, имхо, самое оно


vsimonov [12:58 PM] 
хороший вопрос
Жуков Дмитрий
А почему не пофиг что одна сессия на методы?
Posted in #hw4Today at 12:57 PM


Katherine Buzatu [12:59 PM] 
А если транзакция репозитория не пройдет и будет откат? (edited)


anpotashev [1:04 PM] 
Значит провалится тест

vsimonov [1:04 PM] 
тут получается что сессия у нас не закрывается

anpotashev [1:05 PM] 
Закрывается, когда происходит выход из метода

[1:05] 
а он происходит поссле ассертов


[1:06] 
а в ассертах нам и требуется обращение к lazy полям


Katherine Buzatu [1:11 PM] 
Если тест выполнится в той же транзакции, покажет, что вставка, например, произошла, потом исходная транзакция откатится и в базу ничего не попадет. А тест прошел. Я правильно понимаю ситуацию?

anpotashev [1:12 PM] 
Можно проверить. Добавить что-нибудь после ассерта

[1:13] 
сяс попробую

vsimonov [1:22 PM] 
тут нужно явно сесию закрывать короче


anpotashev [1:29 PM] 
При наличии @Transactional в тестовом классе происходит роллбек после каждого теста, если не указать @Rollback(false) или @Commit перед методом
https://stackoverflow.com/questions/9817388/junit-tests-always-rollback-the-transactions (edited)


vsimonov [1:33 PM] 
вот тут хорошее объяснение

[1:33] 
этой ошибки https://toster.ru/q/368234
«Тостер» — вопросы и ответы
Объясните в чем суть ошибки подключения к базе с Hibernate?
Ответили на вопрос 2 человека. Оцените лучшие ответы! И подпишитесь на вопрос, чтобы узнавать о появлении новых ответов.
 

vsimonov [3:47 PM] 
Кто понял почему у нас в get. user ещё достаётся? Тут реализация метода сама неверна или так и должно быть? Делаю через createQuery

Dmitry Makarov [3:51 PM] 
в гет юзер не достается


Few [3:58 PM] 
User всегда достается вместе с Meal, т.к. в Meal у нас есть поле User


[3:58] 
ORM так работает


Dmitry Makarov [4:01 PM] 
тут еще вопрос в том как понимать слово "достается"


vsimonov [4:01 PM] 
реализуй метод get у тебя жратва с юзеров достанется в jdbc такого не было

Few
[4:02 PM] 
ну если Lazy, то прокси, а если Eager, то весь объект

anpotashev [4:46 PM] 
Кто-нибудь тесты запускал через мавен?
1 reply Today at 4:57 PM View thread

grigory.kislin [5:33 PM] 
@vch
> Вдруг репозиторий что-то не то возвращает.
он как раз не возвращает. и совсем не вдруг


[5:36] 
по поводу транзакций опять же тут написал:
@Transactional в тестах
https://habrahabr.ru/post/232381/
в видео вроде тоже где-то говорю
у нас тесты на контроллеры будут транзакционные. скрипт `@Sql` будет не нужен
Хабрахабр
По следам Spring Pet Clinic. Maven/ Spring Context/ Spring Test/ Spring ORM/ Spring Data JPA
Здравствуйте! Spring MVC, согласно обзору инструментов и технологий Java за 2014 г. от RevbelLabs, является самым популярным веб фреймворком. Далее тот же... (77 kB)
(edited)


[5:37] 
как раз в этом случае с @Transactional тесты будут вести себя не как приложение


[5:38] 
@anpotashev
> Кто-нибудь тесты запускал через мавен?
я:)

vsimonov [5:58 PM] 
Спасибо Гриша за ссылки


Дима Жуков [6:00 PM] 
Так получается это то что надо tranactional?


vsimonov [6:02 PM] 
нет наоборот


anpotashev [6:02 PM] 
Получается поле юзер не надо сравнивать, а следовательно и не будет обращений к лейзи филдам.


vsimonov [6:51 PM] 
в Гришиной ссылке есть решение кто реализует тот молодец :slightly_smiling_face:


Anton K. [7:38 PM] 
Реябят подскажите, почему я создаю конвертор регаю его в спринге и он не работает


russell [7:42 PM] 
А в контексте он виден?


Anton K. [8:11 PM] 
ну аннотировал его как компонент и прпописал сканпакидж


[8:11] 
или надо его в entityManagerFactory


[8:11] 
проперти


[8:11] 
как то прописывать


ujwegh [9:21 PM] 
а как посмотреть в идее код метода? например EntityManager persist. по ctrl+click кидает на интерфейс, а хотелось бы реализацию глянуть


grigory.kislin [9:38 PM] 
@ujwegh
стрелка слева есть или Ctrl+H (edited)


anpotashev [9:41 PM] 
Или Ctrl+Alt+мышь слева


ujwegh [9:44 PM] 
спасибо

Valery [9:45 PM] 
почему в предыдущих реализациях репозитория в еде хранили used_id, а теперь User?
если захочем переключися на jdbc, то снова код еды переписывать?


Argentum_kuh [9:46 PM] 
видимо да. безжалостный и безпощадный ORM

anpotashev [9:48 PM] 
Зачем? просто не будем использовать поле user.


kadmser 
[9:48 PM] 
@Valery чтобы видеть на примере как работает ORM, для этого добавили юзера



Valery [9:59 PM] 
теперь чтобы сохранить еду надо из UserRepository по userId найти User и передать его в сеттер еды. то есть, в классе MealRepo надо держать ссылку на UserRepo.


Valery [10:21 PM] 
это как-то не логично. не соблюдается принцип слабых связей.


Katherine Buzatu [10:28 PM] 
Коллеги, хочу поделиться граблями. Помните, Григорий говорил в теме тестов: "...И следите за тем, чтобы ваши константы не запортились..." Дело было так. Тестирую я метод - тест сам проходит. Запускаю все тесты - этот же тест не проходит. Полтора часа в отладке, и обнаруживаю, что у моей родной константы юзерИд-то не тот! Так вот, один метод менял значение входящего параметра, и так константа благополучно изменила свое состояние и изрядно подпортила мне нервы.


grigory.kislin [10:36 PM] 
@Katherine Buzatu опыт тяжело достается...



RNG [11:25 PM] 
По поводу тестов в`MealServiceTest`. Их можно починить при игноре поля `user` в `assertMatch`. Либо же установкой к каждой константе с едой подходящего юзера (типа такого `ADMIN_MEAL2.setUser(ADMIN)`) но при этом нужно еще добавить `@Transactional` для класса. Какой из подходов верный? Или можеть быть они оба неправильные и есть еще какой-то вариант? (edited)


Katherine Buzatu [11:38 PM] 
Если не собираешься игнорировать Юзера, его, конечно, надо добавить в тестовый набор. У меня получилось в тесте проверять userId без @Transactional


RNG [11:39 PM] 
Ну мне вот тоже не очень понравился вариант с игнором, но во втором включение транзакционности смущало.



[11:39] 
@Katherine Buzatu Если не секрет, каким образом?

Anton K. [11:40 PM] 
org.hibernate.exception.SQLGrammarException: could not extract ResultSet
Caused by: org.postgresql.util.PSQLException: ОШИБКА: столбец meal0_.datetime не существует
Я же правильн опонимаю что причина в том что конвертер не работает??


[11:40] 
Подскажите пожалуйста

Katherine Buzatu [11:41 PM] 
@RNG в AssertJ есть где покопаться.



RNG [11:43 PM] 
@Katherine Buzatu то есть, никакого лишнего кода в `MealServiceTest` типа `updated.setUser(USER)` у тебя нету?


Katherine Buzatu [11:46 PM] 
Я Юзера добавляла в `MealTestData`. Не уверена, что ему именно там место, подумаю еще. Но метод сравнения от этого не зависит.

RNG [11:46 PM] 
@Anton K. может быть неправильно написан запрос? по идее столбец должен быть meal0_.date_time


[11:47] 
@Katherine Buzatu Окей, спасибо за наводку.


Anton K. [11:51 PM] 
просто даже тест get не работает, а там же не запрос пишу а метод у менеджера вызываю


[11:51] 
Не понимаю


RNG [11:52 PM] 
@Anton K. Тесты еды сломались после последних патчей


Anton K. [11:53 PM] 
а


RNG [11:53 PM] 
Мы вот собсно и пытаемся их починить)

Katherine Buzatu [14 hours ago] 
А чинятся, кстати, очень просто, заменой в одном месте в `JdbcMealRepositoryImpl`.


Viktor [12:38 AM] 
@Anton K. какой конвертер? у меня без него все работает



Anton K. [12:43 AM] 
Ну в meals localdatetime и чтобы он мапился из базы корректно нужен конвертер


[12:43] 
как я понял


Katherine Buzatu [12:51 AM] 
> hibernate-core 5.2.x включает hibernate-entitymanager и hibernate-java8, Time API конвертеры уже не нужны.

Anton K. [12 hours ago] 
Если я пишу на JPQL запрос и в нем буду использовать LocaclDateTime идея почеркивает и пишет, мол только number, date or string


Few 
[10 hours ago] 
В запросе с Between у меня тоже подчеркивала идея,  но я поменял на >= AND <=,  так работает


Katherine Buzatu [7 hours ago] 
На between плюется, но работает


Few 
[7 hours ago] 
ну да, но не люблю красноту эту :slightly_smiling_face:


Tanya [6 hours ago] 
сделай SuppressWarnings и краснота уйдет :wink:



Katherine Buzatu [6 hours ago] 
Пусть черкает. Лучше перебдеть, чем недобдеть :slightly_smiling_face:


Tanya [5 hours ago] 
смотря какая сторона перевешивает эстетическая или прагматическая :slightly_smiling_face:


net_ [8:01 AM] 
added and commented on this Plain Text snippet
Expecting:
 <[User{id=100001, email=admin@gmail.com, name=Admin, enabled=true, roles=[ROLE_USER, ROLE_ADMIN], caloriesPerDay=2000},
  User{id=100001, email=admin@gmail.com, name=Admin, enabled=true, roles=[ROLE_USER, ROLE_ADMIN], caloriesPerDay=2000},
  User{id=100010, email=new@gmail.com, name=New, enabled=false, roles=[ROLE_USER], caloriesPerDay=1555},
  User{id=100000, email=user@yandex.ru, name=User, enabled=true, roles=[ROLE_USER], caloriesPerDay=2000}]>
to be equal to:
 <[User{id=100001, email=admin@gmail.com, name=Admin, enabled=true, roles=[ROLE_USER, ROLE_ADMIN], caloriesPerDay=2000},
  User{id=100010, email=new@gmail.com, name=New, enabled=false, roles=[ROLE_USER], caloriesPerDay=1555},
  User{id=100000, email=user@yandex.ru, name=User, enabled=true, roles=[ROLE_USER], caloriesPerDay=2000}]>
1 Comment Collapse
Всем привет. Если у пользователя больше одной роли, то тесты валятся. Кто-то сталкивался с таким?



Few
[8:03 AM] 
а откуда дубль пользователя?


[8:07] 
это который тест?


net_ [8:07 AM] 
это create


[8:08] 
UnitServiceTest


net_ [8:08 AM] 
added and commented on this Plain Text snippet
INSERT INTO users (name, email, password) VALUES
 ('User', 'user@yandex.ru', 'password'),
 ('Admin', 'admin@gmail.com', 'admin');
INSERT INTO user_roles (role, user_id) VALUES
 ('ROLE_USER', 100000),
 ('ROLE_USER', 100001),
 ('ROLE_ADMIN', 100001)
 ;
1 Comment Collapse
Просто добавил еще одну роль админу



net_ [8:09 AM] 
дубль прилетает из базы

Few [8:13 AM] 
а в базе смотрел после этой вставки? там нет дубля?


net_ [8:13 AM] 
нет. там только два пользователя + тот которого добавил в тесте


[8:14] 
те дубль прилетает из Persistency?


Few
[8:15 AM] 
а ты админу вторую роль добавил в тестовых данных и скрипте SQL?


net_ [8:15 AM] 
в скрипте populateDb.sql


Few
[8:16 AM] 
а в тестовых данных?


[8:16] 
UserTestData

net_ [8:17 AM] 
added this Plain Text snippet
  public static final User ADMIN = new User(ADMIN_ID, "Admin", "admin@gmail.com", "admin", Role.ROLE_ADMIN, Role.ROLE_USER);
Add Comment



Few [8:17 AM] 
странно


net_ [8:17 AM] 
to be equal to:
<[User{id=100001, email=admin@gmail.com, name=Admin, enabled=true, roles=[ROLE_USER, ROLE_ADMIN], caloriesPerDay=2000},

[8:18] 
попробуй у себя

Few
[8:18 AM] 
да, сейчас попробую


[8:20] 
да, рушится, интересная ситуация, сейчас будем дебажить

net_ [8:27 AM] 
… причем get по админу возвращает все правильно


Few [8:28 AM] 
запрос с join похоже не верно отрабатывает


net_ [8:28 AM] 
да похоже в getAll

Few [8:39 AM] 
победил, но не уверен что самым правильным способом


Few
[9:09 AM] 
Select distinct в запросе решает проблему


Few [9:16 AM] 
Насколько я понял из объяснения на stack overflow, это возвращаются две ссылки на один объект


[9:21] 
Можно собирать в сет,  тогда он их отфильтрует,  или добавить distinct чтобы  этим hibernate занимался

Katherine Buzatu [9:24 AM] 
> Можно собирать в сет
Это как? Вытащить все с дубликатами, а потом собрать в Сет - типа как distinct, но на нашей стороне?


Few
[9:25 AM] 
Ну да


[9:26] 
Я позже ссылку скину,  сейчас не могу,  на телефоне

[9:27] 
Это по сути не дубликаты,  у entitymanager дубликаиов нет,  это несколько ссылок на один объект


[9:29] 
https://stackoverflow.com/questions/18753245/one-to-many-relationship-gets-duplicate-objects-whithout-using-distinct-why
stackoverflow.com
One-To-Many relationship gets duplicate objects whithout using "distinct".Why?
I have 2 classes in a one-to-many relationship and a HQL query that is a bit strange. Even if I have read some questions already posted, it does not seem clear to me. Class Department{ @OneToMany(
 


net_ [10:18 AM] 
@Few спасибо!


Katherine Buzatu [11:04 AM] 
Развлекалась с Юзерами и Ролями.
```@Enumerated(EnumType.STRING)
    @CollectionTable(name = "user_roles", joinColumns = @JoinColumn(name = "user_id"))
    @Column(name = "role")
    @ElementCollection(fetch = FetchType.EAGER)
    private Set<Role> roles;```
Не заметила в этом месте разницы между FetchType EAGER и LAZY. Логически вроде так и должно быть для таких типов, но прямого указания на такое поведение я нигде не нашла. Кто может подтвердить или опровергнуть?


vch [11:06 AM] 
А почему `Логически вроде так и должно быть для таких типов` ?
Я не экспериментировал, но вроде раз это другая таблица, то при LAZY её подгружать не будем.


Katherine Buzatu [11:07 AM] 
@vch потому что енум сам себе PK. Вот и грузится PK, а по сути - вся информация.


vch [11:12 AM] 
@Katherine Buzatu Не понял...
У нас есть таблица `user_roles` из 2 полей - `user_id` и `role`
В таблице `User` никаких ролей не хранится.
Соответственно, если мы читаем User с Lazy, то он таблицу `user_roles` не прочитает.
Это в теории.


Katherine Buzatu [11:17 AM] 
Ну, да... фигню сморозила...


[11:22] 
Но в дебаге в обоих случаях в getAll есть и Юзеры, и Роли.


vch [11:23 AM] 
@Katherine Buzatu Так ты наверно в отладчике смотришь в репозитории? Когда транзакция ещё не закрыта. Поэтому автоматом подгружаются Lazy поля, к которым ты обращаешься



Eugeniy [11:30 AM] 
Подскажите, пожалуйста, что подразумевается под "проверкой Exception" и куда выводить сводку в конце класса?


Katherine Buzatu [11:32 AM] 
uploaded and commented on this image: Pasted image at 2017-11-27, 11:32 AM
1 Comment
@vch В тесте смотрю, перед сверкой результата. Вот так. И Фетч-Тайп Ленивый.



vch [11:40 AM] 
@Katherine Buzatu Ну, в таком виде информации мало...
Надо смотреть на запрос в репозитории.
Ещё кто-то хотел тесты оборачивать в транзакции, тогда тоже такой эффект будет.


Katherine Buzatu [11:47 AM] 
Это из патчей от Григория.
```return em.createNamedQuery(User.ALL_SORTED, User.class).getResultList();```
в репозитории
```@NamedQuery(name = User.ALL_SORTED, query = "SELECT DISTINCT u FROM User u LEFT JOIN FETCH u.roles ORDER BY u.name, u.email ")```
в User .
Про оборачивание тестов - это не я.


vch [11:48 AM] 
@Katherine Buzatu  Так ты убери `LEFT JOIN FETCH u.roles`

Katherine Buzatu [2 hours ago] 
Ой вэй!!! Надо отдыхать!!!


vch [2 hours ago] 
Да, иногда полезно. 
Но во время topjava приходится жертвовать отдыхом...


grigory.kislin [12:27 PM] 
добавил в урок: 6: При записи в базу через namedQuery валидация ентити не работает, только валидация в бд


[12:32] 
> Если у пользователя больше одной роли, то тесты не проходят
@net_ хорошо, что заметил:+1: мы специально будем добавлять роль и чинить (edited)


grigory.kislin [12:36 PM] 
@Katherine Buzatu на тему загрузке при дебаге есть же в https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson04.md#-Подсказки-по-hw4 жирным шрифтом: 
*Внимание: проверять запросы Hibernate нужно через run. Если делаете debug и брекпойнт, то могут делаться лишние запросы к базе (дебаггер дергает toString)* (edited)

Katherine Buzatu [1 hour ago] 
Мы не ищем легких путей и подсказки смотрим после выполнения задания. Я благодаря этому многое потрогала своими руками и получила бесценный опыт.


grigory.kislin [27 minutes ago] 
может перенести не в подсказки а выше тогда?


Katherine Buzatu [18 minutes ago] 
Не, так неинтересно. А как же эксперименты?


itAvgur [1:03 PM] 
Кхм... при запуске тестов юзера ловлю:
Invocation of init method failed; nested exception is java.lang.NoSuchMethodError: javax.persistence.Table.indexes()[Ljavax/persistence/Index
Это бага или фича?


grigory.kislin [1:18 PM] 
@itAvgur это зависит от того, что делаешь:)


itAvgur [1:19 PM] 
т.е. это поведение норм?
ок, тогда копаю дальше :slightly_smiling_face:
